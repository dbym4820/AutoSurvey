<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学術論文RSSリーダー</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel" data-type="module">
    const { 
      RefreshCw, BookOpen, Calendar, ExternalLink, Sparkles, 
      Filter, ChevronDown, ChevronUp, Loader2, LogIn, LogOut, 
      User, AlertCircle, Database, Clock, Settings, Plus, 
      Trash2, Edit, Check, X, TestTube, Rss, Globe, Tag,
      ToggleLeft, ToggleRight, Search, FileText, Palette
    } = lucideReact;

    const API_BASE = '/api';

    const AVAILABLE_COLORS = [
      { id: 'bg-blue-500', name: '青' },
      { id: 'bg-purple-500', name: '紫' },
      { id: 'bg-green-500', name: '緑' },
      { id: 'bg-orange-500', name: 'オレンジ' },
      { id: 'bg-red-500', name: '赤' },
      { id: 'bg-teal-500', name: 'ティール' },
      { id: 'bg-indigo-500', name: 'インディゴ' },
      { id: 'bg-pink-500', name: 'ピンク' },
      { id: 'bg-yellow-500', name: '黄' },
      { id: 'bg-gray-500', name: 'グレー' },
    ];

    const CATEGORIES = ['AIED', 'Learning Sciences', 'Cognitive Science', 'EdTech', 'Educational Psychology', 'Computer Science', 'Other'];

    // ログインフォーム
    function LoginForm({ onLogin }) {
      const [username, setUsername] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError(''); setLoading(true);
        try {
          const res = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            credentials: 'include', body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'ログインに失敗しました');
          onLogin(data.user);
        } catch (err) { setError(err.message); }
        finally { setLoading(false); }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100">
          <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div className="flex items-center justify-center gap-3 mb-8">
              <div className="p-3 bg-indigo-100 rounded-xl"><BookOpen className="w-8 h-8 text-indigo-600" /></div>
              <div>
                <h1 className="text-2xl font-bold text-gray-900">学術論文RSSリーダー</h1>
                <p className="text-sm text-gray-500">AI in Education研究支援システム</p>
              </div>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              {error && <div className="p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700">
                <AlertCircle className="w-4 h-4" /><span className="text-sm">{error}</span>
              </div>}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">ユーザー名</label>
                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)}
                  className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required />
              </div>
              <button type="submit" disabled={loading}
                className="w-full py-2.5 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center gap-2 font-medium">
                {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : <LogIn className="w-4 h-4" />} ログイン
              </button>
            </form>
          </div>
        </div>
      );
    }

    // 論文誌追加/編集モーダル
    function JournalModal({ journal, onSave, onClose }) {
      const isEdit = !!journal;
      const [formData, setFormData] = React.useState({
        id: journal?.id || '', name: journal?.name || '', fullName: journal?.full_name || '',
        publisher: journal?.publisher || '', rssUrl: journal?.rss_url || '',
        category: journal?.category || 'Other', color: journal?.color || 'bg-blue-500',
      });
      const [testing, setTesting] = React.useState(false);
      const [testResult, setTestResult] = React.useState(null);
      const [saving, setSaving] = React.useState(false);
      const [error, setError] = React.useState('');

      const handleChange = (field, value) => { setFormData(prev => ({ ...prev, [field]: value })); setError(''); };

      const handleTestRss = async () => {
        if (!formData.rssUrl) { setError('RSS URLを入力してください'); return; }
        setTesting(true); setTestResult(null); setError('');
        try {
          const res = await fetch(`${API_BASE}/admin/journals/test-rss`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            credentials: 'include', body: JSON.stringify({ rssUrl: formData.rssUrl }),
          });
          const data = await res.json();
          if (data.success) setTestResult(data);
          else setError(data.error || 'RSSフィードの取得に失敗しました');
        } catch (err) { setError('RSSフィードのテストに失敗しました'); }
        finally { setTesting(false); }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.id || !formData.name || !formData.fullName || !formData.publisher || !formData.rssUrl) {
          setError('すべての必須項目を入力してください'); return;
        }
        setSaving(true); setError('');
        try {
          const url = isEdit ? `${API_BASE}/admin/journals/${journal.id}` : `${API_BASE}/admin/journals`;
          const method = isEdit ? 'PUT' : 'POST';
          const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' },
            credentials: 'include', body: JSON.stringify(formData) });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          onSave(data.journal || formData);
        } catch (err) { setError(err.message); }
        finally { setSaving(false); }
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                  {isEdit ? <Edit className="w-5 h-5" /> : <Plus className="w-5 h-5" />}
                  {isEdit ? '論文誌を編集' : '新しい論文誌を追加'}
                </h2>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg"><X className="w-5 h-5" /></button>
              </div>
            </div>
            <form onSubmit={handleSubmit} className="p-6 space-y-5">
              {error && <div className="p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700">
                <AlertCircle className="w-4 h-4" /><span className="text-sm">{error}</span>
              </div>}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ID <span className="text-red-500">*</span></label>
                  <input type="text" value={formData.id} onChange={(e) => handleChange('id', e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ''))}
                    disabled={isEdit} placeholder="例: ijaied"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100" />
                  <p className="text-xs text-gray-500 mt-1">英小文字・数字・ハイフンのみ</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">略称 <span className="text-red-500">*</span></label>
                  <input type="text" value={formData.name} onChange={(e) => handleChange('name', e.target.value)} placeholder="例: IJAIED"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">正式名称 <span className="text-red-500">*</span></label>
                <input type="text" value={formData.fullName} onChange={(e) => handleChange('fullName', e.target.value)}
                  placeholder="例: International Journal of Artificial Intelligence in Education"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">出版社 <span className="text-red-500">*</span></label>
                  <input type="text" value={formData.publisher} onChange={(e) => handleChange('publisher', e.target.value)} placeholder="例: Springer"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                  <select value={formData.category} onChange={(e) => handleChange('category', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </select>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">RSS URL <span className="text-red-500">*</span></label>
                <div className="flex gap-2">
                  <input type="url" value={formData.rssUrl} onChange={(e) => handleChange('rssUrl', e.target.value)} placeholder="https://..."
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                  <button type="button" onClick={handleTestRss} disabled={testing}
                    className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center gap-2 text-sm font-medium disabled:opacity-50">
                    {testing ? <Loader2 className="w-4 h-4 animate-spin" /> : <TestTube className="w-4 h-4" />} テスト
                  </button>
                </div>
              </div>
              {testResult && (
                <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                  <div className="flex items-center gap-2 text-green-700 font-medium mb-2"><Check className="w-4 h-4" /> RSSフィード取得成功</div>
                  <div className="text-sm text-green-800 space-y-1">
                    <p>フィードタイトル: {testResult.feedTitle}</p>
                    <p>記事数: {testResult.itemCount}件</p>
                    {testResult.sampleItems?.length > 0 && (
                      <div className="mt-2">
                        <p className="font-medium">サンプル記事:</p>
                        <ul className="list-disc list-inside text-xs mt-1 space-y-1">
                          {testResult.sampleItems.map((item, i) => <li key={i} className="truncate">{item.title}</li>)}
                        </ul>
                      </div>
                    )}
                  </div>
                </div>
              )}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">表示色</label>
                <div className="flex flex-wrap gap-2">
                  {AVAILABLE_COLORS.map(color => (
                    <button key={color.id} type="button" onClick={() => handleChange('color', color.id)}
                      className={`w-8 h-8 rounded-lg ${color.id} ${formData.color === color.id ? 'ring-2 ring-offset-2 ring-indigo-500' : ''}`} title={color.name} />
                  ))}
                </div>
              </div>
              <div className="flex gap-3 pt-4 border-t border-gray-200">
                <button type="button" onClick={onClose} className="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">キャンセル</button>
                <button type="submit" disabled={saving}
                  className="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 font-medium flex items-center justify-center gap-2">
                  {saving ? <Loader2 className="w-4 h-4 animate-spin" /> : <Check className="w-4 h-4" />} {isEdit ? '更新' : '追加'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // 論文誌管理ページ
    function JournalManagement({ onBack }) {
      const [journals, setJournals] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [showModal, setShowModal] = React.useState(false);
      const [editingJournal, setEditingJournal] = React.useState(null);
      const [showInactive, setShowInactive] = React.useState(false);
      const [fetchingJournal, setFetchingJournal] = React.useState(null);

      React.useEffect(() => { fetchJournals(); }, [showInactive]);

      const fetchJournals = async () => {
        setLoading(true);
        try {
          const url = showInactive ? `${API_BASE}/journals?all=true` : `${API_BASE}/journals`;
          const res = await fetch(url, { credentials: 'include' });
          const data = await res.json();
          if (data.success) setJournals(data.journals);
        } catch (error) { console.error('Failed to fetch journals:', error); }
        finally { setLoading(false); }
      };

      const handleSave = () => { setShowModal(false); setEditingJournal(null); fetchJournals(); };
      const handleEdit = (journal) => { setEditingJournal(journal); setShowModal(true); };

      const handleDelete = async (journal) => {
        if (!confirm(`「${journal.name}」を無効化しますか？`)) return;
        try {
          await fetch(`${API_BASE}/admin/journals/${journal.id}`, { method: 'DELETE', credentials: 'include' });
          fetchJournals();
        } catch (error) { alert('削除に失敗しました'); }
      };

      const handleActivate = async (journal) => {
        try {
          await fetch(`${API_BASE}/admin/journals/${journal.id}/activate`, { method: 'POST', credentials: 'include' });
          fetchJournals();
        } catch (error) { alert('有効化に失敗しました'); }
      };

      const handleFetchNow = async (journal) => {
        setFetchingJournal(journal.id);
        try {
          const res = await fetch(`${API_BASE}/admin/journals/${journal.id}/fetch`, { credentials: 'include' });
          const data = await res.json();
          if (data.success) alert(`${journal.name}: ${data.result.newPapers || 0}件の新規論文を取得しました`);
          else alert('取得に失敗しました: ' + (data.error || ''));
        } catch (error) { alert('取得に失敗しました'); }
        finally { setFetchingJournal(null); }
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
            <div className="max-w-6xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg"><ChevronDown className="w-5 h-5 rotate-90" /></button>
                  <div className="p-2 bg-indigo-100 rounded-lg"><Settings className="w-6 h-6 text-indigo-600" /></div>
                  <div>
                    <h1 className="text-xl font-bold text-gray-900">論文誌管理</h1>
                    <p className="text-sm text-gray-500">RSSフィードの追加・編集・削除</p>
                  </div>
                </div>
                <button onClick={() => { setEditingJournal(null); setShowModal(true); }}
                  className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                  <Plus className="w-4 h-4" /> 新しい論文誌を追加
                </button>
              </div>
            </div>
          </header>
          <main className="max-w-6xl mx-auto px-4 py-6">
            <div className="mb-6 flex items-center justify-between">
              <div className="flex items-center gap-2 text-sm text-gray-600"><Database className="w-4 h-4" />{journals.length}件の論文誌</div>
              <label className="flex items-center gap-2 cursor-pointer">
                <span className="text-sm text-gray-600">無効な論文誌も表示</span>
                <button onClick={() => setShowInactive(!showInactive)}
                  className={`w-10 h-6 rounded-full transition-colors ${showInactive ? 'bg-indigo-600' : 'bg-gray-300'}`}>
                  <div className={`w-4 h-4 bg-white rounded-full transition-transform m-1 ${showInactive ? 'translate-x-4' : ''}`} />
                </button>
              </label>
            </div>
            {loading ? (
              <div className="flex items-center justify-center py-12"><Loader2 className="w-8 h-8 animate-spin text-indigo-600" /></div>
            ) : (
              <div className="grid gap-4">
                {journals.map(journal => (
                  <div key={journal.id} className={`bg-white rounded-xl shadow-sm border p-5 ${journal.is_active === 0 ? 'opacity-60 border-gray-300' : 'border-gray-200'}`}>
                    <div className="flex items-start gap-4">
                      <div className={`w-2 self-stretch rounded-full ${journal.color}`} />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="font-semibold text-gray-900">{journal.name}</h3>
                          <span className="text-xs px-2 py-0.5 bg-gray-100 rounded-full text-gray-600">{journal.category}</span>
                          {journal.is_active === 0 && <span className="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded-full">無効</span>}
                        </div>
                        <p className="text-sm text-gray-600 mb-1">{journal.full_name}</p>
                        <div className="flex items-center gap-4 text-xs text-gray-500">
                          <span className="flex items-center gap-1"><Globe className="w-3 h-3" />{journal.publisher}</span>
                          <span className="flex items-center gap-1"><FileText className="w-3 h-3" />{journal.paper_count || 0}件</span>
                          {journal.last_fetched_at && <span className="flex items-center gap-1"><Clock className="w-3 h-3" />最終取得: {new Date(journal.last_fetched_at).toLocaleString('ja-JP')}</span>}
                        </div>
                        <div className="mt-2 text-xs text-gray-400 truncate"><Rss className="w-3 h-3 inline mr-1" />{journal.rss_url}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        {journal.is_active !== 0 && (
                          <button onClick={() => handleFetchNow(journal)} disabled={fetchingJournal === journal.id}
                            className="p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="今すぐ取得">
                            {fetchingJournal === journal.id ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                          </button>
                        )}
                        <button onClick={() => handleEdit(journal)} className="p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg" title="編集"><Edit className="w-4 h-4" /></button>
                        {journal.is_active === 0 ? (
                          <button onClick={() => handleActivate(journal)} className="p-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-lg" title="有効化"><ToggleRight className="w-4 h-4" /></button>
                        ) : (
                          <button onClick={() => handleDelete(journal)} className="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg" title="無効化"><Trash2 className="w-4 h-4" /></button>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            <div className="mt-8 p-6 bg-white rounded-xl shadow-sm border border-gray-200">
              <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2"><Rss className="w-5 h-5 text-orange-500" />主要出版社のRSS URL形式</h2>
              <div className="space-y-3 text-sm">
                <div className="p-3 bg-gray-50 rounded-lg"><p className="font-medium text-gray-700">Springer</p>
                  <code className="text-xs text-gray-600">https://link.springer.com/search.rss?facet-content-type=Article&facet-journal-id=<span className="text-indigo-600">[JOURNAL_ID]</span></code></div>
                <div className="p-3 bg-gray-50 rounded-lg"><p className="font-medium text-gray-700">Wiley</p>
                  <code className="text-xs text-gray-600">https://onlinelibrary.wiley.com/action/showFeed?jc=<span className="text-indigo-600">[ISSN]</span>&type=etoc&feed=rss</code></div>
                <div className="p-3 bg-gray-50 rounded-lg"><p className="font-medium text-gray-700">Elsevier (ScienceDirect)</p>
                  <code className="text-xs text-gray-600">https://rss.sciencedirect.com/publication/science/<span className="text-indigo-600">[ISSN]</span></code></div>
                <div className="p-3 bg-gray-50 rounded-lg"><p className="font-medium text-gray-700">SAGE</p>
                  <code className="text-xs text-gray-600">https://journals.sagepub.com/action/showFeed?ui=0&mi=ehikzz&ai=2b4&jc=<span className="text-indigo-600">[JOURNAL_CODE]</span>&type=etoc&feed=rss</code></div>
              </div>
            </div>
          </main>
          {showModal && <JournalModal journal={editingJournal} onSave={handleSave} onClose={() => { setShowModal(false); setEditingJournal(null); }} />}
        </div>
      );
    }

    // メインアプリケーション
    function MainApp({ user, onLogout }) {
      const [currentPage, setCurrentPage] = React.useState('papers');
      const [papers, setPapers] = React.useState([]);
      const [journals, setJournals] = React.useState([]);
      const [selectedJournals, setSelectedJournals] = React.useState([]);
      const [dateFilter, setDateFilter] = React.useState('month');
      const [summaries, setSummaries] = React.useState({});
      const [loadingSummary, setLoadingSummary] = React.useState({});
      const [expandedPaper, setExpandedPaper] = React.useState(null);
      const [isRefreshing, setIsRefreshing] = React.useState(false);
      const [showJournalFilter, setShowJournalFilter] = React.useState(false);
      const [loading, setLoading] = React.useState(true);
      const [pagination, setPagination] = React.useState({ total: 0 });
      const [aiProviders, setAiProviders] = React.useState([]);
      const [selectedProvider, setSelectedProvider] = React.useState('claude');

      const dateOptions = [{ value: 'week', label: '過去7日' }, { value: 'month', label: '過去30日' }, { value: 'all', label: 'すべて' }];

      const getDateRange = React.useCallback(() => {
        const now = new Date(); let dateFrom = null;
        if (dateFilter === 'week') dateFrom = new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        else if (dateFilter === 'month') dateFrom = new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        return { dateFrom };
      }, [dateFilter]);

      const fetchJournals = React.useCallback(async () => {
        try {
          const res = await fetch(`${API_BASE}/journals`, { credentials: 'include' });
          const data = await res.json();
          if (data.success) { setJournals(data.journals); if (selectedJournals.length === 0) setSelectedJournals(data.journals.map(j => j.id)); }
        } catch (error) { console.error('Failed to fetch journals:', error); }
      }, []);

      React.useEffect(() => { fetchJournals(); }, [fetchJournals]);

      React.useEffect(() => {
        async function fetchProviders() {
          try {
            const res = await fetch(`${API_BASE}/summaries/providers`, { credentials: 'include' });
            const data = await res.json();
            if (data.success) { setAiProviders(data.providers); setSelectedProvider(data.current); }
          } catch (error) { console.error('Failed to fetch providers:', error); }
        }
        fetchProviders();
      }, []);

      React.useEffect(() => {
        async function fetchPapers() {
          if (selectedJournals.length === 0) { setPapers([]); return; }
          setLoading(true);
          try {
            const { dateFrom } = getDateRange();
            const params = new URLSearchParams();
            params.set('journals', selectedJournals.join(','));
            if (dateFrom) params.set('dateFrom', dateFrom);
            params.set('limit', '100');
            const res = await fetch(`${API_BASE}/papers?${params}`, { credentials: 'include' });
            const data = await res.json();
            if (data.success) { setPapers(data.papers); setPagination(data.pagination); }
          } catch (error) { console.error('Failed to fetch papers:', error); }
          finally { setLoading(false); }
        }
        if (currentPage === 'papers') fetchPapers();
      }, [selectedJournals, dateFilter, getDateRange, currentPage]);

      const toggleJournal = (journalId) => { setSelectedJournals(prev => prev.includes(journalId) ? prev.filter(id => id !== journalId) : [...prev, journalId]); };

      const generateSummary = async (paper) => {
        setLoadingSummary(prev => ({ ...prev, [paper.id]: true }));
        try {
          const res = await fetch(`${API_BASE}/summaries/generate`, { method: 'POST', headers: { 'Content-Type': 'application/json' },
            credentials: 'include', body: JSON.stringify({ paperId: paper.id, provider: selectedProvider }) });
          const data = await res.json();
          if (data.success) { setSummaries(prev => ({ ...prev, [paper.id]: data.summary })); setExpandedPaper(paper.id); }
          else throw new Error(data.error);
        } catch (error) { alert('要約の生成に失敗しました: ' + error.message); }
        finally { setLoadingSummary(prev => ({ ...prev, [paper.id]: false })); }
      };

      const handleManualFetch = async () => {
        if (!user.isAdmin) return;
        setIsRefreshing(true);
        try {
          const res = await fetch(`${API_BASE}/admin/scheduler/run`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include' });
          const data = await res.json();
          if (data.success) { alert(`取得完了: ${data.result.newPapers}件の新規論文`); window.location.reload(); }
        } catch (error) { alert('取得に失敗しました'); }
        finally { setIsRefreshing(false); }
      };

      const handleLogout = async () => {
        try { await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' }); onLogout(); }
        catch (error) { console.error('Logout failed:', error); }
      };

      const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
      };

      if (currentPage === 'journals') return <JournalManagement onBack={() => { setCurrentPage('papers'); fetchJournals(); }} />;

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
            <div className="max-w-6xl mx-auto px-4 py-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-indigo-100 rounded-lg"><BookOpen className="w-6 h-6 text-indigo-600" /></div>
                  <div>
                    <h1 className="text-xl font-bold text-gray-900">学術論文RSSリーダー</h1>
                    <p className="text-sm text-gray-500">AI in Education / Cognitive Science</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <button onClick={() => setCurrentPage('journals')} className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    <Settings className="w-4 h-4" /> 論文誌管理
                  </button>
                  {user.isAdmin && (
                    <button onClick={handleManualFetch} disabled={isRefreshing}
                      className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                      <RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin' : ''}`} /> {isRefreshing ? '取得中...' : 'フィード取得'}
                    </button>
                  )}
                  <div className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg">
                    <User className="w-4 h-4 text-gray-600" />
                    <span className="text-sm font-medium text-gray-700">{user.username}</span>
                    {user.isAdmin && <span className="text-xs bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded">管理者</span>}
                  </div>
                  <button onClick={handleLogout} className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg" title="ログアウト"><LogOut className="w-5 h-5" /></button>
                </div>
              </div>
            </div>
          </header>
          <main className="max-w-6xl mx-auto px-4 py-6">
            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
              <div className="flex flex-wrap gap-4 items-center justify-between">
                <div className="relative">
                  <button onClick={() => setShowJournalFilter(!showJournalFilter)}
                    className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    <Filter className="w-4 h-4" /><span>論文誌 ({selectedJournals.length}/{journals.length})</span>
                    {showJournalFilter ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                  </button>
                  {showJournalFilter && (
                    <div className="absolute top-full left-0 mt-2 w-96 bg-white rounded-xl shadow-xl border border-gray-200 p-4 z-20">
                      {journals.map(journal => (
                        <label key={journal.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                          <input type="checkbox" checked={selectedJournals.includes(journal.id)} onChange={() => toggleJournal(journal.id)} className="w-4 h-4 text-indigo-600 rounded" />
                          <span className={`w-3 h-3 rounded-full ${journal.color}`} />
                          <div className="flex-1">
                            <div className="text-sm font-medium">{journal.name}</div>
                            <div className="text-xs text-gray-500">{journal.category} • {journal.paper_count || 0}件</div>
                          </div>
                        </label>
                      ))}
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <Calendar className="w-4 h-4 text-gray-500" />
                  <select value={dateFilter} onChange={(e) => setDateFilter(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    {dateOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                  </select>
                </div>
                {aiProviders.length > 0 && (
                  <div className="flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-gray-500" />
                    <select value={selectedProvider} onChange={(e) => setSelectedProvider(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                      {aiProviders.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </select>
                  </div>
                )}
                <div className="text-sm text-gray-600 font-medium">{pagination.total}件の論文</div>
              </div>
            </div>
            {loading ? (
              <div className="flex items-center justify-center py-12"><Loader2 className="w-8 h-8 animate-spin text-indigo-600" /></div>
            ) : (
              <div className="space-y-4">
                {papers.map(paper => {
                  const isExpanded = expandedPaper === paper.id;
                  const summary = summaries[paper.id];
                  const isLoadingSummary = loadingSummary[paper.id];
                  return (
                    <div key={paper.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-all">
                      <div className="p-5">
                        <div className="flex items-start gap-4">
                          <div className={`w-1.5 self-stretch rounded-full ${paper.journal_color}`} />
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2 flex-wrap">
                              <span className={`px-2.5 py-1 text-xs font-medium text-white rounded-lg ${paper.journal_color}`}>{paper.journal_name}</span>
                              <span className="text-xs text-gray-500">{formatDate(paper.published_date)}</span>
                              {paper.has_summary > 0 && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">要約済</span>}
                            </div>
                            <h3 className="text-lg font-semibold text-gray-900 mb-2">{paper.title}</h3>
                            <p className="text-sm text-gray-600 mb-3">{Array.isArray(paper.authors) ? paper.authors.join(', ') : paper.authors}</p>
                            <p className="text-sm text-gray-700 mb-4 line-clamp-3">{paper.abstract}</p>
                            <div className="flex items-center gap-3 flex-wrap">
                              <button onClick={() => generateSummary(paper)} disabled={isLoadingSummary}
                                className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm rounded-lg hover:from-indigo-600 hover:to-purple-600 disabled:opacity-50 font-medium">
                                {isLoadingSummary ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />}
                                {isLoadingSummary ? '生成中...' : 'AI要約'}
                              </button>
                              <a href={paper.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 px-3 py-2 text-sm text-gray-600 hover:text-indigo-600">
                                <ExternalLink className="w-4 h-4" />論文を開く
                              </a>
                              {summary && (
                                <button onClick={() => setExpandedPaper(isExpanded ? null : paper.id)} className="flex items-center gap-1 text-sm text-indigo-600 font-medium">
                                  {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                  {isExpanded ? '閉じる' : '要約を表示'}
                                </button>
                              )}
                            </div>
                            {summary && isExpanded && (
                              <div className="mt-4 p-5 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                                <div className="flex items-center justify-between mb-4">
                                  <div className="flex items-center gap-2"><Sparkles className="w-5 h-5 text-indigo-600" /><span className="font-medium text-indigo-900">AI要約</span></div>
                                  <span className="text-xs px-2 py-1 bg-indigo-100 rounded-full text-indigo-600">{summary.ai_provider}</span>
                                </div>
                                <div className="space-y-4 text-sm text-gray-800">
                                  {summary.purpose && <div><span className="font-semibold text-indigo-700">【研究目的】</span><p className="mt-1">{summary.purpose}</p></div>}
                                  {summary.methodology && <div><span className="font-semibold text-indigo-700">【手法】</span><p className="mt-1">{summary.methodology}</p></div>}
                                  {summary.findings && <div><span className="font-semibold text-indigo-700">【主な発見】</span><p className="mt-1">{summary.findings}</p></div>}
                                  {summary.implications && <div><span className="font-semibold text-indigo-700">【教育への示唆】</span><p className="mt-1">{summary.implications}</p></div>}
                                  {!summary.purpose && summary.summary_text && <p className="whitespace-pre-wrap">{summary.summary_text}</p>}
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            {!loading && papers.length === 0 && (
              <div className="text-center py-16">
                <BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <p className="text-gray-500 text-lg">条件に一致する論文がありません</p>
              </div>
            )}
          </main>
        </div>
      );
    }

    // ルートコンポーネント
    function App() {
      const [user, setUser] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        async function checkAuth() {
          try {
            const res = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
            const data = await res.json();
            if (data.authenticated) setUser(data.user);
          } catch (error) { console.error('Auth check failed:', error); }
          finally { setLoading(false); }
        }
        checkAuth();
      }, []);

      if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-100"><Loader2 className="w-8 h-8 animate-spin text-indigo-600" /></div>;
      if (!user) return <LoginForm onLogin={setUser} />;
      return <MainApp user={user} onLogout={() => setUser(null)} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
